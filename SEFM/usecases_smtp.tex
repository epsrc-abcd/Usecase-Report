%%%%%%%%%%%% SMTP

\subsection{The Simple Mail Transfer Protocol}

The SMTP is an internet standard for electronic
mail transfer. It originally followed
RFC 821~\cite{SMTP-rfc} and was later extended
in RFC 5321~\cite{ESMTP-rfc}, which is the version consider here.
SMTP is an application layer protocol, that typically runs on
a TCP/IP connection.

\paragraph{Motivation:}
The session typed implementation of the STMP has to offer
a number of motivations for using session types for software
development.
Firstly, it demonstrates how {\em natural} it is
to describe of a widely used standard protocol in session types.
Secondly, and in contrast with the HTTP, it is
a rather state-full protocol (\mybf{see state machine diagram below}),
i.e.~ it requires implementation of a sequence of communication states.
The complexity of states adds to the effort of
developing SMTP. With the use of session typed
support that effort can be reduced.
Thirdly, the SMTP implies streaming a tree
data-structure that corresponds to the structure
of an email.
It is thus, shown how session types can describe
the streaming of tree data-structures.


%This section gives a more detailed presentation of the SMTP
%usecase. SMTP is considered an important implementation for
%session types since it incorporates challenges that in principle
%software engineers face.
%
%The SMTP is a protocol that, in contrast with the HTTP, requires handling
%communication through a number of distinct states ,
%which adds a degree of complexity to the implementation.
%With the help of session types and the methods and procedures
%session types support developers can reduce the effort
%needed to handle the complexity.
%
%Furthermore, SMTP introduces a structure on an email,
%which is composed by subject, main part and attachments
%as well as meta-data for the email. Streaming such
%tree-structured data types over the network is a task that
%can be rigorously handled and ensured by session types,
%due to its structured natured. Transforming
%network data-structures (e.g.~text headers)
%to/from session types structures is an important
%procedure to understand when applying session types.

%%In this report we describe the implementation of
%%an application layer communication protocol.

\paragraph{Implementation:}
The implementation of the SMTP starts with
the definition of a global protocol that describes
the interaction between a client and the server.
The global protocol can be found in \appref{}.

An SMTP interaction is an exchange of text-based {commands}
between a client and the server.
For example, the client may send the
\lstinline|EHLO| 

An SMTP interaction consists of an exchange of text-based {commands}
between the client and the server.
For example, the client sends the
\lstinline|EHLO| command to identify itself and open the connection with
the server.
%
The commands \lstinline|MAIL FROM| : $<$address$>$ and \lstinline|RCPT TO| : $<$address$>$
specify the e-mail address of the sender and the
receiver of the e-mail.
%
The \lstinline|DATA| command allows the client to specify the text of
the e-mail. The \lstinline|QUIT| command is used to terminate the
session and close the connection. The responses from the server have the
following format: three digits followed by an optional dash ``-'', such
as \lstinline|250-|, and then some text, like OK. The server might reply
to \lstinline|EHLO| with \lstinline|250| $<$text$>$ or to
\lstinline|MAIL FROM| or \lstinline|RCPT TO| with \lstinline|250| OK.


The implementation of the protocol implements an interaction between
a Simple Mail Transfer Protocol (SMTP) client and a \lstinline|gmail| server.


The global protocol for the SMTP is defined in Scribble,
based on Hu's work~\cite{HuR:smtp}.

\input{figures/fig-smtp_global}

The above Scribble protocol formally specifies
the description in \secref{sec: smtp_description}.
The global protocol \lstinline|SMTP| specifies
an interaction between two roles being the client ant the server of the protocol.
The protocol is then projected to the
individual communication specifications of each
of the participant roles.

%%
The global protocol is used to project the communication
behaviour of roles \lstinline|C| and \lstinline|S|.
The focus is on the projection of the client
since the interest is on interacting with a real server.

This part of SMTP describes a loop (\lstinline|rec Z1|) where the client chooses
among the messages \lstinline|SUBJECT|, to send the subject,
\lstinline|DATALINE|, to send a line of text, or \lstinline|ATAD| to terminate the e-mail by sending a dot.

\input{figures/fig-smtp_local}

The local type can be represented as a state
machine:

\input{figures/fig-state_machine}
